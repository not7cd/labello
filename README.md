# Labello

Aim of this project is to create label library and control software for zebra printer and other alike.

## Development

```bash
# we are using poetry for dependency management
poetry install

# run once to create secrets
source env.sh

# run once to create database
poetry run python helpers/db_create.py

# run app in for development in virtual env
FLASK_APP=labello.web FLASK_ENV=development poetry run flask run
# or
poetry run python -m labello
```

## Printer Setup

Labello supports two ways of communicating with the printer: via CUPS or by writing directly to a USB device.

### Option A: CUPS Setup

Labello sends raw printer commands (e.g., EPL) to the printer via CUPS. To work correctly, the printer should be configured as a **Raw Queue** in CUPS.

> **Note**: Recent versions of CUPS have deprecated raw queues and PPD-based drivers. While this method still works in most current distributions, it may be removed in future versions of CUPS. If you encounter issues or want a more future-proof setup, consider **Option B**.

#### 1. Install CUPS

On Debian-based systems:
```bash
sudo apt update
sudo apt install cups
```

#### 2. Configure the Printer

1.  Open the CUPS web interface at `http://localhost:631` (or the IP of your CUPS server).
2.  Go to the **Administration** tab and click **Add Printer**.
3.  Select your printer from the list of **Local Printers**.
4.  Provide a name (e.g., `Zebra_LP2824`). This name must match `LABELLO_PRINTER_NAME`.
5.  When asked for a **Make**, select **Generic** (or **Raw** if available).
6.  When asked for a **Model**, select **Raw Queue (en)**.
    - *Note*: If you see "Zebra" with "EPL1" or "EPL2" options, you can select those, but since Labello sends raw commands, the "Raw Queue" is preferred to avoid any driver interference.
7.  Click **Add Printer** and set default options.

Alternatively, you can create a raw queue using the command line:
```bash
lpadmin -p Zebra_LP2824 -E -v usb://Zebra/LP2824?serial=... -m raw
```
(Replace the URL with your printer's URI, which you can find by running `lpinfo -v`).

#### 3. Remote CUPS (Optional)

If CUPS is running on a different machine than Labello:
1.  On the CUPS server, enable "Share printers connected to this system" in the Administration tab.
2.  Ensure the CUPS server is listening on its network interface. You might need to run `cupsctl --remote-admin --remote-any` or edit `/etc/cups/cupsd.conf`.
3.  Set `LABELLO_PRINTER_HOST` to `server_ip:631` in Labello's environment.

### Option B: Direct USB Device

If you prefer not to use CUPS, you can send commands directly to the printer device file (e.g., `/dev/usb/lp0`).

1.  Identify your printer device file (usually `/dev/usb/lp0` or `/dev/lp0`).
2.  Ensure the user running Labello has write permissions to this device:
    ```bash
    sudo usermod -a -G lp $USER
    ```
    (You may need to log out and back in for this to take effect).
3.  Set the `LABELLO_PRINTER_DEVICE` environment variable to the device path.

### Option C: Dummy Printer (for Development)

If you don't have a printer connected, you can use a dummy printer that just logs the commands.

1.  Set `LABELLO_PRINTER_TYPE` to `dummy`.

## Configuration

You can configure Labello using environment variables:

- `LABELLO_PRINTER_TYPE`: (Optional) `cups` (default), `device`, or `dummy`.
- `LABELLO_PRINTER_DEVICE`: Path to the printer device (e.g., `/dev/usb/lp0`). Required if `LABELLO_PRINTER_TYPE` is `device`.
- `LABELLO_PRINTER_NAME`: Name of the printer as configured in CUPS (default: `Zebra_LP2824`).
- `LABELLO_PRINTER_HOST`: CUPS host and port (default: `localhost:631`).

Other configurable variables:
- `LABELLO_SECRET_KEY`: Flask secret key (autogenerated by `source env.sh`).
- `LABELLO_BASE_URL`: Base URL for the application.
- `LABELLO_HOME_URL`: Home URL for branding.
- `LABELLO_IMAGES_PATH`: Path to store rendered label images.

You can set these in your environment or add them to `env.sh`.

## Deploy

```
systemctl edit helpers/labello.service
```